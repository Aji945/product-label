<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>搜索系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body class="bg-gray-50">
    <div class="min-h-screen flex flex-col">
        <div class="w-full bg-gray-50 transition-all duration-300" id="searchContainer">
            <div class="max-w-2xl mx-auto px-4 py-4">
                <h1 class="text-4xl font-bold text-center mb-8">搜索系统</h1>
                
                <div class="relative">
                    <input
                        type="text"
                        id="searchInput"
                        class="w-full px-4 py-2 rounded-full border focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="輸入關鍵詞搜索..."
                    >
                    
                    <button 
                        id="clearButton"
                        onclick="clearSearch()"
                        class="absolute right-20 top-1/2 -translate-y-1/2 px-2 text-gray-400 hover:text-gray-600 hidden"
                    >
                        <i class="fas fa-times"></i>
                    </button>
                    
                    <button 
                        onclick="handleSearch()"
                        class="absolute right-3 top-1/2 -translate-y-1/2 px-4 py-1 bg-blue-500 text-white rounded-full hover:bg-blue-600"
                    >
                        搜索
                    </button>

                    <div id="suggestions" class="absolute w-full mt-1 bg-white rounded-lg shadow-lg border hidden">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="flex-1">
            <div class="max-w-2xl mx-auto px-4">
                <div id="results" class="mt-8 space-y-4"></div>
            </div>
        </div>
    </div>

    <div class="fixed bottom-6 right-6 flex flex-col gap-4">
        <a href="https://line.me/ti/p/95aeasIFGP" 
           target="_blank"
           class="w-12 h-12 bg-[#00B900] rounded-full flex items-center justify-center shadow-lg hover:opacity-90 transition-opacity">
            <i class="fab fa-line text-white text-2xl"></i>
        </a>
        
        <a href="tel:+886908851249"
           class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center shadow-lg hover:opacity-90 transition-opacity">
            <i class="fas fa-phone text-white text-xl"></i>
        </a>
    </div>

    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50">
        <div class="relative max-w-4xl max-h-[90vh] mx-4">
            <img id="modalImage" src="" alt="" class="max-w-full max-h-[90vh] object-contain">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-white text-xl hover:text-gray-300">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <script>
        const API_KEY = 'AIzaSyCvZiOO5ax2WekV95A6C4--0YbDVZVBToQ';
        const SHEET_ID = '15pOyPD6HYcjsfoqkKcuyQeXPMjE3pE9gTTGgIt6MbuA';
        
        const searchInput = document.getElementById('searchInput');
        const suggestionsDiv = document.getElementById('suggestions');
        const resultsDiv = document.getElementById('results');

        let timeoutId;
        searchInput.addEventListener('input', () => {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(fetchSuggestions, 300);
        });

        async function fetchSuggestions() {
            const query = searchInput.value.trim();
            if (query.length < 2) {
                suggestionsDiv.classList.add('hidden');
                return;
            }

            try {
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/A:E?key=${API_KEY}`
                );
                const data = await response.json();
                const rows = data.values || [];

                const suggestions = rows
                    .filter(row => {
                        // 檢查A-E欄位是否包含搜尋關鍵字
                        return row.slice(0, 5).some(cell => 
                            cell?.toLowerCase().includes(query.toLowerCase())
                        );
                    })
                    .slice(0, 5);

                if (suggestions.length > 0) {
                    suggestionsDiv.innerHTML = suggestions
                        .map(row => `
                            <div class="px-4 py-2 hover:bg-gray-100 cursor-pointer" 
                                 onclick="handleSuggestionClick('${row[0]}')">
                                <div class="font-medium">${row[0]}</div>
                                <div class="text-sm text-gray-500">
                                    ${row.slice(1, 5).filter(Boolean).join(' • ')}
                                </div>
                            </div>
                        `).join('');
                    suggestionsDiv.classList.remove('hidden');
                } else {
                    suggestionsDiv.classList.add('hidden');
                }
            } catch (error) {
                console.error('獲取建議失敗:', error);
            }
        }

        function handleSuggestionClick(value) {
            searchInput.value = value;
            suggestionsDiv.classList.add('hidden');
            handleSearch();
        }

        async function handleSearch() {
            const query = searchInput.value.trim();
            if (!query) return;

            suggestionsDiv.classList.add('hidden');
            resultsDiv.innerHTML = '<div class="text-center">搜索中...</div>';

            try {
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/A:M?key=${API_KEY}`
                );
                const data = await response.json();
                const [headers, ...rows] = data.values || [];

                const results = rows.filter(row => {
                    const searchableFields = row.slice(0, 5).join(' ').toLowerCase();
                    return searchableFields.includes(query.toLowerCase());
                });

                if (results.length > 0) {
                    resultsDiv.innerHTML = `
                        <p class="text-sm text-gray-600 mb-4">找到 ${results.length} 個結果</p>
                        ${results.map((row, index) => `
                            <div class="bg-white p-4 rounded-lg shadow hover:shadow-md">
                                <h2 class="text-xl font-semibold text-blue-600 mb-3">${row[0] || ''}</h2>
                                
                                <div class="flex gap-4">
                                    ${row[5] ? `
                                        <div class="flex-shrink-0 w-32 h-32">
                                            <img src="${getGoogleDriveImageUrl(row[5])}" 
                                                 alt="${row[0]}" 
                                                 class="w-full h-full object-cover rounded cursor-pointer"
                                                 onclick="openModal('${getGoogleDriveViewUrl(row[5])}')"
                                                 onerror="this.onerror=null; this.src='https://via.placeholder.com/128?text=無圖片';">
                                        </div>
                                    ` : `
                                        <div class="flex-shrink-0 w-32 h-32 bg-gray-200 rounded flex items-center justify-center">
                                            <span class="text-gray-400">無圖片</span>
                                        </div>
                                    `}
                                    
                                    <div class="flex-grow grid grid-cols-1 gap-1.5">
                                        ${row.slice(1, 5).map((value, i) => value ? `
                                            <div class="flex items-center text-sm">
                                                <span class="inline-block w-20 flex-shrink-0 text-gray-500">${headers[i + 1]}</span>
                                                <span class="text-gray-900">${value}</span>
                                            </div>
                                        ` : '').join('')}
                                    </div>
                                </div>

                                <button 
                                    onclick="toggleDetails(${index})"
                                    class="mt-4 w-full px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                                >
                                    查看詳細資訊
                                </button>

                                <div id="details-${index}" class="hidden mt-4">
                                    <div class="grid grid-cols-1 gap-4">
                                        ${headers.slice(6).map((header, i) => row[i + 6] ? `
                                            <div class="bg-gray-50 p-3 rounded">
                                                <h3 class="font-semibold text-gray-700">${header}</h3>
                                                <p class="text-gray-600 whitespace-pre-line mt-1">${row[i + 6]}</p>
                                            </div>
                                        ` : '').join('')}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    `;
                } else {
                    resultsDiv.innerHTML = '<div class="text-center">未找到相關結果</div>';
                }
            } catch (error) {
                console.error('搜索失败:', error);
                resultsDiv.innerHTML = '<div class="text-center text-red-500">搜索失败，请稍后重试</div>';
            }
        }

        function toggleDetails(index) {
            const detailsDiv = document.getElementById(`details-${index}`);
            const isHidden = detailsDiv.classList.contains('hidden');
            detailsDiv.classList.toggle('hidden');
            
            const button = detailsDiv.previousElementSibling;
            button.textContent = isHidden ? '收起詳細資訊' : '查看詳細資訊';
        }

        function openModal(imgSrc) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            
            // 先設置載入中的提示
            modalImg.src = 'https://via.placeholder.com/400?text=載入中...';
            
            // 預載圖片
            const img = new Image();
            img.onload = function() {
                modalImg.src = imgSrc;
            };
            img.onerror = function() {
                modalImg.src = 'https://via.placeholder.com/400?text=圖片載入失敗';
            };
            img.src = imgSrc;
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // 點擊背景關閉
            modal.onclick = function(e) {
                if (e.target === modal) {
                    closeModal();
                }
            };
            
            // ESC 鍵關閉
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeModal();
                }
            });
        }

        function closeModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function clearSearch() {
            searchInput.value = '';
            document.getElementById('clearButton').classList.add('hidden');
            suggestionsDiv.classList.add('hidden');
            resultsDiv.innerHTML = '';
            searchInput.focus();
        }

        // 監聽輸入框變化，顯示/隱藏清除按鈕
        searchInput.addEventListener('input', () => {
            const clearButton = document.getElementById('clearButton');
            if (searchInput.value) {
                clearButton.classList.remove('hidden');
            } else {
                clearButton.classList.add('hidden');
            }
        });

        // 監聽滾動事件，固定搜尋框
        window.addEventListener('scroll', () => {
            const searchContainer = document.getElementById('searchContainer');
            const header = document.querySelector('h1');
            
            if (window.scrollY > 100) {
                searchContainer.classList.add('fixed', 'top-0', 'left-0', 'right-0', 'shadow-md', 'z-10');
                header.classList.add('hidden');
            } else {
                searchContainer.classList.remove('fixed', 'top-0', 'left-0', 'right-0', 'shadow-md', 'z-10');
                header.classList.remove('hidden');
            }
        });

        function extractFileId(url) {
            if (url && url.includes('drive.google.com')) {
                let fileId;
                if (url.includes('/open?id=')) {
                    fileId = url.split('/open?id=')[1].split('&')[0];
                } else if (url.includes('/file/d/')) {
                    fileId = url.split('/file/d/')[1].split('/')[0];
                } else if (url.includes('/folders/')) {
                    fileId = url.split('/folders/')[1].split('?')[0];
                }
                return fileId;
            }
            return null;
        }

        function getGoogleDriveImageUrl(url) {
            const fileId = extractFileId(url);
            if (fileId) {
                return `https://drive.google.com/uc?export=view&id=${fileId}`;
            }
            return url;
        }

        function getGoogleDriveViewUrl(url) {
            const fileId = extractFileId(url);
            if (fileId) {
                return `https://drive.google.com/file/d/${fileId}/view`;
            }
            return url;
        }
    </script>
</body>
</html> 